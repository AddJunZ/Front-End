<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>canvas图片压缩</title>
</head>
<body>
  <input id="file" type="file" onchange="changeImage(event)">
  <script>
    function changeImage(e){
      let file = e.target.files[0];
      console.log('未压缩的文件', file);
      let name = file.name;
      let reader = new FileReader();
      // 转base64
      reader.readAsDataURL(file);

      // 新建image容器存放之后的base64
      let image = new Image();

      // base64读取完毕
      reader.onload = function(e){
        // base64的结果
        let base64 = e.target.result;
        console.log('base64',base64.length);
        // 将base6放在img容器里
        image.src = base64;
      }

      // 图片的base64格式加载完毕后
      image.onload = function(){
        // 使用canvas来存储图片
        let canvas = document.createElement('canvas');
        let context = canvas.getContext('2d');

        // 图片原始尺寸（分辨率）
        let oldWidth = this.width;
        let oldHeight = this.height;
        console.log(oldWidth,oldHeight);

        // 压缩比率
        let rate = 2;
        let newWidth = parseInt(oldWidth / rate);
        let newHeight = parseInt(oldHeight / rate);

        // canvas绘制
        canvas.width = newWidth;
        canvas.height = newHeight;
        context.clearRect(0, 0, newWidth, newHeight);
        context.drawImage(image, 0, 0, newWidth, newHeight);

        // 转换类型
        let type = 'jpeg';
        // canvas压缩绘制后的base64
        let data = canvas.toDataURL(`image/${type}`);
        console.log('data',data.length);
        // console.log('data',data);

        console.log('压缩后的文件',dataURLtoFile(data, name, type));
      }
    }
    
    // 根据base64转图片file
    function dataURLtoFile(base64, name, type){
      //data:image/jpeg;base64,/9j/4AAQ
      let arr = base64.split(',');
      // atob() 函数能够解码通过base-64编码的字符串数据
      let bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while(n--){
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new File([u8arr], name, {type});
    }
  </script>
</body>
</html>